[gd_scene load_steps=11 format=2]

[ext_resource path="res://src/components/bullet-related/bullet type/PlayerBullet.tscn" type="PackedScene" id=1]
[ext_resource path="res://src/components/bullet-related/BulletSpawner.tscn" type="PackedScene" id=2]
[ext_resource path="res://src/components/bullet-related/bullet_emitters/BulletEmitterSpread.gd" type="Script" id=3]
[ext_resource path="res://src/entities/items/weapons/range/shotgun/Shotgun.gd" type="Script" id=4]
[ext_resource path="res://assets/items/weapons/shotgun.png" type="Texture" id=5]

[sub_resource type="Animation" id=1]
resource_name = "RESET"
tracks/0/type = "value"
tracks/0/path = NodePath("Position2D/Sprite:position")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/keys = {
"times": PoolRealArray( 0 ),
"transitions": PoolRealArray( 1 ),
"update": 0,
"values": [ Vector2( 0, 0 ) ]
}

[sub_resource type="Animation" id=2]
resource_name = "Shoot"
length = 0.15
step = 0.01
tracks/0/type = "value"
tracks/0/path = NodePath("Position2D/Sprite:position")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/keys = {
"times": PoolRealArray( 0, 0.0368341, 0.0838562, 0.128841 ),
"transitions": PoolRealArray( 1, 1, 1, 0.143587 ),
"update": 0,
"values": [ Vector2( 0, 0 ), Vector2( -10, 0 ), Vector2( 5, 0 ), Vector2( 0, 0 ) ]
}
tracks/1/type = "method"
tracks/1/path = NodePath(".")
tracks/1/interp = 1
tracks/1/loop_wrap = true
tracks/1/imported = false
tracks/1/enabled = true
tracks/1/keys = {
"times": PoolRealArray( 0, 0.15 ),
"transitions": PoolRealArray( 1, 1 ),
"values": [ {
"args": [  ],
"method": "bullet_spawner_set_shooting_true"
}, {
"args": [  ],
"method": "bullet_spawner_set_shooting_false"
} ]
}

[sub_resource type="GDScript" id=5]
script/source = "tool
class_name BulletSpawner
extends Position2D

# Called whenever a shot is ready and shooting is false
signal shot_ready()

# Scene to use as a bullet, it's script needs to extend Bullet
export var bullet_scene: PackedScene
# time between shots
export var shot_delay: float = .1
# speed of the emitted bullets
export var bullet_speed: float = 400

export var bullet_damage_value = 5
export var bullet_knockback_value = 20

# the emitter to be used for spawning bullets (controls behaviour)
var bullet_emitter: BulletEmitter

# offset to the rotation, added to BulletSpawners rotation
var rotation_offset: float = 0.0

var can_shoot: bool = false

onready var timer := Timer.new()

func _ready() -> void:
	if Engine.editor_hint:
		return
	add_child(timer)
	timer.wait_time = shot_delay
	timer.one_shot = false
	timer.autostart = false
	timer.connect(\"timeout\", self, \"_shoot\")
	if bullet_emitter:
		bullet_emitter.setup(self, bullet_scene)
	else:
		printerr(\"emitter in BulletSpawner is not a BulletEmitter!\")
		queue_free()

func set_shooting(val: bool) -> void:
	if val:
		can_shoot = true
		if timer.is_stopped():
			_shoot()
			timer.start()
	else:
		can_shoot = false

func _shoot() -> void:
	if not can_shoot:
		timer.stop()
		emit_signal(\"shot_ready\")
		return
	var shoot_dir = Vector2.RIGHT.rotated(global_rotation + rotation_offset).normalized()
	bullet_emitter.shoot(global_position, shoot_dir, bullet_speed, bullet_damage_value, bullet_knockback_value)

# Workaround for resource list
func _get_property_list() -> Array:
	var exported_resource_property: Dictionary = {
		\"name\":\"bullet_emitter\",
		\"type\":TYPE_OBJECT,
		\"hint\":PROPERTY_HINT_RESOURCE_TYPE,
		\"hint_string\": \"BulletEmitter\",
		\"usage\": PROPERTY_USAGE_DEFAULT | PROPERTY_USAGE_SCRIPT_VARIABLE
		}
	return [exported_resource_property]
"

[sub_resource type="Resource" id=6]
resource_local_to_scene = true
script = ExtResource( 3 )
amount = 4
spread_angle = 5.0

[sub_resource type="CapsuleShape2D" id=4]
radius = 11.0

[node name="Shotgun" type="Node2D"]
script = ExtResource( 4 )
entity_name = "SHOTGUN"
max_ammo = 50

[node name="Position2D" type="Position2D" parent="."]
position = Vector2( 7, 0 )

[node name="Sprite" type="Sprite" parent="Position2D"]
texture = ExtResource( 5 )

[node name="AnimationPlayer" type="AnimationPlayer" parent="Position2D"]
root_node = NodePath("../..")
anims/RESET = SubResource( 1 )
anims/Shoot = SubResource( 2 )

[node name="BulletSpawner" parent="Position2D" instance=ExtResource( 2 )]
position = Vector2( 18, -6 )
script = SubResource( 5 )
bullet_scene = ExtResource( 1 )
shot_delay = 0.4
bullet_speed = 300.0
bullet_damage_value = 20
bullet_knockback_value = 5
bullet_emitter = SubResource( 6 )

[node name="Pickupbox" type="Area2D" parent="Position2D" groups=["ITEM"]]

[node name="CollisionShape2D" type="CollisionShape2D" parent="Position2D/Pickupbox"]
position = Vector2( 0, -2 )
rotation = 1.5708
shape = SubResource( 4 )

[node name="DespawnTimer" type="Timer" parent="Position2D"]
one_shot = true
